<!DOCTYPE html>
<html>
<head>
	<title>Home</title>
	<link rel="stylesheet" href="../CSS/home.css">
</head>
<body onload="getGroup();">
	<div class="image">
		<img src="../Images/tempicon.png">
	</div>
	<div class="navbar">
		<a class="active" href="studentHome.html">Home</a>
		<a href="studentContactInfo.html">Contact Info</a>
		<a href="studentMessage.html">Message Team</a>
		<a href="studentAccount.html">Account</a>
	</div>
	<div style="margin-left: 225px">
		<div class="student partner">
			<h1> Team Files </h1>
			<p> Credentials take time to load. Please hit refresh after logging in. </p>
			<fieldset style="float:right;">
				<legend> Upload File </legend>
				<input type="file" id="fileButton" style="float:right"/>
			</fieldset>
			<fieldset style="float:right;">
				<legend> Create New File </legend>
				<input type="button" value="Create" id="firepad"/>
			</fieldset>
			<table id="student" cellpadding="10">
			</table>
		</div>
		<div class="advisor coordinator">
			<h1> Group Files </h1>
			<p> Credentials take time to load. Please hit refresh after logging in. </p>
			<fieldset style="float:right;">
				<legend> Add Users </legend>
				<input type="file" id="fileUpload" />
				<input type="button" id="upload" value="Upload" onclick = "Upload()" />
			</fieldset>
		</div>
	</div>
	<!--The following code was generated by Firebase in order to upload it to our storage there -->
</fieldset>

<script src="https://www.gstatic.com/firebasejs/4.6.0/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.6.0/firebase-firestore.js"></script>
<script>
// Initialize Firebase
var config =
{
	apiKey: "AIzaSyDfBsx-cINFNm1qhEwCP80gEmmEc5rvSnw",
	authDomain: "softwareengineeringproje-be6d0.firebaseapp.com",
	databaseURL: "https://softwareengineeringproje-be6d0.firebaseio.com",
	projectId: "softwareengineeringproje-be6d0",
	storageBucket: "softwareengineeringproje-be6d0.appspot.com",
	messagingSenderId: "350274872134"
};

firebase.initializeApp(config);
var firestore = firebase.firestore();
window.getGroup();
window.getClass();
window.loadFiles(localStorage.getItem('group'));
window.loadAllFiles();


/*if (window.localStorage.getItem('class') == 'student') {
	let display = document.querySelector('.student');
	console.log(display);
	let hideDisplay = document.querySelector('.advisor');
	display.style = "display:block;"
	hideDisplay.style = "display:none;"
	window.loadFiles(localStorage.getItem('group'));
} else if (window.localStorage.getItem('class') == ('projectadvisor' | 'coursecoordinator')) {
	let display = document.querySelector('.advisor');
	let hideDisplay = document.querySelector('.student');
	display.style = "display:block;"
	hideDisplay.style = "display:none;"
}*/


function getGroup() {
	////Insert method for finding group of logged-in user
	firebase.auth().onAuthStateChanged(function(user) {
		if (user != null) {
			var email = user.email;
			window.localStorage.setItem("user", email);
		}
	});
	var useremail = window.localStorage.getItem("user");
	var docRef = firestore.collection("/Class/classDocument/UsersByEmail/").doc(useremail);

	docRef.get().then(function(doc) {
		if (doc.exists) {
			var group = doc.data().group;
			var name = doc.data().name;
			window.localStorage.setItem("group", group);
			window.localStorage.setItem("name", name);
		} else {
			console.log("No such user!");
		}
	}).catch(function(error) {
		console.log("Error getting user:", error);
	});
}

function getClass() {
	var docRef = firestore.collection("/Class/classDocument/Groups/" + window.localStorage.getItem('group') + "/Users/").doc(window.localStorage.getItem('name'));
	docRef.get().then(function(doc) {
		if (doc.exists) {
			window.localStorage.setItem('class', doc.data().class);
		} else {
			console.log("No such user!");
		}
	}).catch(function(error) {
		console.log("Error getting user:", error);
	});
}


function loadFiles(group) {
	var table = document.getElementById('student');
	var docRef = firestore.collection("/Class/classDocument/Groups/" + group + "/Files").get().then(function(querySnapshot) {
		querySnapshot.forEach(function(doc) {
			displayFile(doc.data().name, doc.data().link, table.id, document.getElementById("student").rows.length);
		});
	});
}

function loadAllFiles() {
	var i = 0;
	let display = document.querySelector('.advisor');
	var listGroups = firestore.collection("/Class/classDocument/Groups/").get().then(function(querySnapshot) {
    querySnapshot.forEach(function(doc) {
				var container = document.createElement('div');
        var title = document.createElement('h1');
				title.innerHTML = doc.id;
				var table = document.createElement('table');
				table.id = '.table' + i;
				container.appendChild(title);
				container.appendChild(table);
				display.appendChild(container);
				var docRef2 = firestore.collection("/Class/classDocument/Groups/" + doc.id + "/Files").get().then(function(querySnapshot) {
					querySnapshot.forEach(function(doc2) {
						displayFile(doc2.data().name, doc2.data().link, table.id, table.rows.length);
					});
				});
				i++;
    });
	});
}

var fileButton = document.getElementById("fileButton");

/*The following code for the choose file and upload file was obtained from https://community.thunkable.com/t/uploading-files-to-firebase/1916 */
fileButton.addEventListener('change', function(e){
	var file = e.target.files[0];
	var location = localStorage.getItem("group") + "/" + file.name;
	var storageRef = firebase.storage().ref(location);
	storageRef.put(file);
	var absLocation = "https://firebasestorage.googleapis.com/v0/b/softwareengineeringproje-be6d0.appspot.com/o/" + localStorage.getItem("group") + "%2F"  + file.name + "?alt=media&token=23a50f35-7cbc-4006-95a3-605197e5fef9";

	/*End copied code*/
	var docRef = firestore.collection("/Class/classDocument/Groups/" + localStorage.getItem("group") + "/Files").doc(file.name);
	docRef.set({
		name: file.name,
		link: absLocation,
	}).then(function(docRef) {
		console.log("Saved.");
	}).catch(function(error) {
		console.error("Error adding document: ", error);
	});
	var table = document.getElementById('student');
	window.displayFile(file.name, absLocation, table.id, table.rows.length);
})

var firepadButton = document.getElementById("firepad");

firepadButton.addEventListener('click', function() {
	var ref = firebase.database().ref();
	var hash = window.location.hash.replace(/#/g, '');

	if (hash) {
		ref = ref.child(hash);
	} else {
		ref = ref.push(); // generate unique location.
	}
	if (typeof console !== 'undefined') {
		console.log('Firebase data: ', ref.toString());
	}

	var filename = window.prompt("What woud you like to name your file?");
	var link = "https://softwareengineeringproje-be6d0.firebaseapp.com/Student/Editor.html?#" + ref.key;

	var docRef = firestore.collection("/Class/classDocument/Groups/" + localStorage.getItem("group") + "/Files").doc(filename + ".fp");
	docRef.set({
		name: filename + ".fp",
		link: link,
	}).then(function(docRef) {
		console.log("Saved.");
	}).catch(function(error) {
		console.error("Error adding document: ", error);
	});

	displayFile(filename + ".fp", link);
})

function displayFile(filename, link, tableID, rows){
	var list = document.getElementById(tableID);
	var a = document.createElement('a');
	a.href = link;

	var feedbackButton = document.createElement('a');
	feedbackButton.href = "feedback.html?a=#" + filename;
	var button = document.createElement('input');
	button.type = 'button';
	button.value = "Add Feedback";
	feedbackButton.appendChild(button);

	var row = list.insertRow(rows);
	var name = row.insertCell(0);
	var download = row.insertCell(1);
	var feedback = row.insertCell(2);
	var grade = row.insertCell(3);

	name.innerHTML = filename;

	if(filename.slice(-3) == 'pdf') {
		feedback.appendChild(feedbackButton);
		localStorage.setItem("#" + filename, link);
	}

	if(filename.slice(-2) == 'fp') {
		a.innerHTML = "Edit";
	} else {
		a.innerHTML = "Download";
	}

	download.appendChild(a);
}

</script>

<script type="text/javascript">
var firestore = firebase.firestore();
function Upload() {
	var fileUpload = document.getElementById("fileUpload");
	var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
	if (regex.test(fileUpload.value.toLowerCase()))
	{
		if (typeof (FileReader) != "undefined")
		{
			var reader = new FileReader();
			reader.onload = function(csv)
			{
				//split CSV file into rows
				var rows = csv.target.result.split("\n");
				for(var i = 0; i < rows.length; i++)
				{
					//split each row into name, email, group, and classification
					//to be used when creating a user
					var currentline = rows[i].split(",");
					var name = currentline[0];
					console.log("name: " + name);
					var email= currentline[1];
					console.log("email: " + email);
					var group = currentline[2];
					console.log("group: " + group);
					var classification = currentline[3];
					console.log("type " + classification);

					//create the user and add it to the database
					createUser(name, email, group, classification);

				}
			}
			reader.readAsText(fileUpload.files[0]);
		}
		else
		{
			alert("This browser does not support HTML5.");
		}
	}
	else
	{
		alert("Please upload a valid CSV file.");
	}

	window.alert("You have successfully added users!");
}

//creates a user in firebase Cloud FireStore
function createUser(userName, userEmail, userGroup, userClassification)
{
	//gets reference to the location the user will be created
	var docRef = firestore.collection("/Class/classDocument/Groups/" + userGroup + "/Users/").doc(userName);
	docRef.set({
		name: userName,
		email: userEmail,
		group: userGroup,
		class: userClassification
	}).then(function(docRef) {
		console.log("Saved.");
	}).catch(function(error) {
		console.error("Error adding document: ", error);
	});

	var docRef2 = firestore.collection("/Class/classDocument/UsersByEmail").doc(userEmail);
	docRef2.set({
		group: userGroup,
		name: userName,
	}).then(function(docRef) {
		console.log("Saved.");
	}).catch(function(error) {
		console.error("Error adding document: ", error);
	});
}
</script>

</body>
</html>
