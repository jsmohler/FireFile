<!DOCTYPE html>
<html>
<head>
	<title>Home</title>
	<link rel="stylesheet" href="../CSS/home.css">
</head>
<body onload="getGroup();">
	<div class="image">
		<img src="../Images/tempicon.png">
	</div>
	<div class="navbar">
		<a class="active" href="studentHome.html">Home</a>
		<a href="studentContactInfo.html">Contact Info</a>
		<a href="studentMessage.html">Message Team</a>
		<a href="studentAccount.html">Account</a>
	</div>
	<div style="margin-left: 225px">
		<h1> Team Files </h1>
		<fieldset style="float:right;">
			<legend> Upload File </legend>
			<input type="file" id="fileButton" style="float:right"/>
		</fieldset>
		<fieldset style="float:right;">
			<legend> Create New File </legend>
			<input type="button" value="Create" id="firepad"/>
		</fieldset>
		<table id="fileNames" cellpadding="10">
		</table>
	</div>
	<!--The following code was generated by Firebase in order to upload it to our storage there -->
</fieldset>

<script src="https://www.gstatic.com/firebasejs/4.6.0/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.6.0/firebase-firestore.js"></script>
<script>
// Initialize Firebase
var config =
{
	apiKey: "AIzaSyDfBsx-cINFNm1qhEwCP80gEmmEc5rvSnw",
	authDomain: "softwareengineeringproje-be6d0.firebaseapp.com",
	databaseURL: "https://softwareengineeringproje-be6d0.firebaseio.com",
	projectId: "softwareengineeringproje-be6d0",
	storageBucket: "softwareengineeringproje-be6d0.appspot.com",
	messagingSenderId: "350274872134"
};

firebase.initializeApp(config);
window.loadFiles();

function getGroup() {
	////Insert method for finding group of logged-in user
	firebase.auth().onAuthStateChanged(function(user) {
		if (user != null) {
			var email = user.email;
			window.localStorage.setItem("user", email);
		}
	});
	var username = window.localStorage.getItem("user");
	var firestore = firebase.firestore();
	var docRef = firestore.collection("/Class/classDocument/UsersByEmail/").doc(username);

	docRef.get().then(function(doc) {
		if (doc.exists) {
			var group = doc.data().Group;
			window.localStorage.setItem("group", group);
		} else {
			console.log("No such user!");
		}
	}).catch(function(error) {
		console.log("Error getting user:", error);
	});
}

function loadFiles(){
	var firestore = firebase.firestore();
	var docRef = firestore.collection("/Class/classDocument/Groups/" + localStorage.getItem("group") + "/Files").get().then(function(querySnapshot) {
		querySnapshot.forEach(function(doc) {
			displayFile(doc.data().name, doc.data().link);
		});
	});
}

var fileButton = document.getElementById("fileButton");
var i = 0;

/*The following code for the choose file and upload file was obtained from https://community.thunkable.com/t/uploading-files-to-firebase/1916 */
fileButton.addEventListener('change', function(e){
	var file = e.target.files[0];
	var location = localStorage.getItem("group") + "/" + file.name;
	var storageRef = firebase.storage().ref(location);
	storageRef.put(file);
	var absLocation = "https://firebasestorage.googleapis.com/v0/b/softwareengineeringproje-be6d0.appspot.com/o/" + localStorage.getItem("group") + "%2F"  + file.name + "?alt=media&token=23a50f35-7cbc-4006-95a3-605197e5fef9";

	/*End copied code*/
	var firestore = firebase.firestore();
	var docRef = firestore.collection("/Class/classDocument/Groups/" + localStorage.getItem("group") + "/Files").doc(file.name);
	docRef.set({
		name: file.name,
		link: absLocation,
	}).then(function(docRef) {
			console.log("Saved.");
	}).catch(function(error) {
			console.error("Error adding document: ", error);
	});

	window.displayFile(file.name, absLocation);
})

var firepadButton = document.getElementById("firepad");

firepadButton.addEventListener('click', function() {
	var ref = firebase.database().ref();
	var hash = window.location.hash.replace(/#/g, '');

	if (hash) {
		ref = ref.child(hash);
	} else {
		ref = ref.push(); // generate unique location.
	}
	if (typeof console !== 'undefined') {
		console.log('Firebase data: ', ref.toString());
	}

	var filename = window.prompt("What woud you like to name your file?");
	var link = "https://softwareengineeringproje-be6d0.firebaseapp.com/Student/Editor.html?#" + ref.key;

	var firestore = firebase.firestore();
	var docRef = firestore.collection("/Class/classDocument/Groups/" + localStorage.getItem("group") + "/Files").doc(filename + ".fp");
	docRef.set({
		name: filename + ".fp",
		link: link,
	}).then(function(docRef) {
			console.log("Saved.");
	}).catch(function(error) {
			console.error("Error adding document: ", error);
	});

	displayFile(filename + ".fp", link);
})

function displayFile(filename, link){
	var list = document.getElementById('fileNames');
	var a = document.createElement('a');

	a.href = link;

	var feedbackButton = document.createElement('a');
	feedbackButton.href = "feedback.html?a=#" + filename;
	var button = document.createElement('input');
	button.type = 'button';
	button.value = "Add Feedback";
	feedbackButton.appendChild(button);

	var row = list.insertRow(i);
	var name = row.insertCell(0);
	var download = row.insertCell(1);
	var feedback = row.insertCell(2);
	var grade = row.insertCell(3);

	name.innerHTML = filename;

	if(filename.slice(-3) == 'pdf') {
		feedback.appendChild(feedbackButton);
		localStorage.setItem("#" + filename, link);
	}

	if(filename.slice(-2) == 'fp') {
		a.innerHTML = "Edit";
	} else {
		a.innerHTML = "Download";
	}

	download.appendChild(a);
	i = i+1;
}

</script>

</body>
</html>
